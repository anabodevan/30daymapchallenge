{
  "hash": "c8a33559ea0ae791e896fec502900cfb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lines\"\nauthor: \"Ana Luisa Bodevan\"\ndescription: \"Decline in Brazil's railway network\"\nimage: \"02_lines.png\"\nexecute:\n  warning: false\n  message: false\n  eval: true\nformat:\n  html:\n    code-tools: true\n    code-fold: true\n---\n\n# Day 2: Lines\n\n| Challenge Classic: Map linear features (e.g., roads, rivers, migration paths, flow lines). Explore line thickness, color, and direction to convey information.\n\nBrazil's railway network has declined since its peak in the 20th century because of a number of reasons, from the crisis in coffee market during the Great Depression to a policy of highway expansion and lobby from car manufacturers in the 1950s. [BBC](https://www.bbc.com/portuguese/articles/cp3qlyk3vy2o) has a pretty cool article about it (in portuguese). Overall, Brazilian railway network lost over 8.000 kilometers since the 20th century.\n\nFor Day 2 of the #30DayMapChallenge my idea was to map the decline in Brazil's railway network.\n\n## 1. Setup\n\n### 1.1 Load libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pacman)\npacman :: p_load(tidyverse, sf, here, geobr, rnaturalearth, readxl, ragg, showtext, glue, patchwork, scales, cowplot)\n```\n:::\n\n\n### 1.2 Load data \nThe data used is from the [Banco de Informações de Transportes](https://www.gov.br/transportes/pt-br/assuntos/dados-de-transportes/bit/bit-mapas) (BIT) from the Ministry of Transport. Data of the extension of railways over the years is from IBGE\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::opts_knit$set(root.dir = here::here())\n\n# read railway shapefile \nzip_path <- here(\"2025/02_lines/BaseFerro.zip\")\nextract_dir <- here(\"2025/02_lines/BaseFerro\")\nunzip(zip_path, exdir = extract_dir)\nshp_file <- list.files(extract_dir, pattern = \"\\\\.shp$\", recursive = TRUE, full.names = TRUE)[1]\nshp_rail <- sf::st_read(shp_file, quiet = TRUE)\n\n# get brazil and south america shapefiles \nshp_br <- read_state()\n\nshp_latam <- ne_countries(type = \"countries\", continent = \"south america\", returnclass = \"sf\")\n\nshp_latam <- shp_latam %>% \n  st_transform(crs = st_crs(shp_br))\n\n# read kilometer extension\nkm <- readxl::read_xls(\"kms.xls\")\n```\n:::\n\n\n## 2. Data Wrangling \n\n### 2.1 Tidy kilometer extension data \n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(km) <- km[3, ]\nkm <- km[-(1:3), ]\nkm <- km[-(133:135), ]\nrownames(km) <- NULL\ncolnames(km) <- c(\"YEAR\", \"KM\")\nkm$YEAR <- gsub(\"\\\\.+\", \"\", km$YEAR) # get the right col names and clean it up \n\nkm$YEAR <- as.integer(km$YEAR)\nkm$KM <- as.integer(km$KM)\n\nkm <- km |> \n  arrange(YEAR) |> \n  mutate(\n    delta_km = KM - lag(KM),\n    pct_change = 100 * delta_km / lag(KM)\n  )\n\nkm <- km   |> \n  add_row(YEAR = 2025, KM = 29165) |> \n  arrange(YEAR) |> \n  mutate(\n    delta_km = KM - lag(KM),\n    pct_change = 100 * delta_km / lag(KM)\n  ) # 2025 data from ANTT\n```\n:::\n\n\n### 2.2 Tidy names in shp_rail\n\n::: {.cell}\n\n```{.r .cell-code}\nshp_rail <- shp_rail |> \n  mutate(\n    status = factor(\n      tip_situac, levels = c(\"Em Operação\", \"Em Obra\", \"Planejada\", \"Estudo\", \"Desativada\", NA),\n      labels = c(\"Operating\", \"Under Repair\", \"Under Study\", \"Under Study\", \"Deactivated\")\n    )\n  ) |> \n  filter(!is.na(status))\n```\n:::\n\n\n### 2.3 Create bounding box\nWe have to exclude the state of Espiríto Santo of the bounding box because it has islands that may distort the map if included.\n\n::: {.cell}\n\n```{.r .cell-code}\nbbox <- shp_br |> \n  filter(abbrev_state != \"ES\") |> \n  st_bbox()\n```\n:::\n\n\n## 3. Plot \n\n### 3.1 Fonts and text \n\n::: {.cell}\n\n```{.r .cell-code}\nfont_add_google(\"Inter\", \"inter\", bold.wt = 800, regular.wt = 400)\nshowtext_auto()\n\ntitle <- \"Brazil's Railways (2023)\"\nsubtitle <- \"Since its peak in 1960 with 34,252 km, Brazil's\\nrailways have declined by over 8,000 km\"\ncaption <- \"#30DayMapChallenge Day 2 - Lines\\nData: ANNT & IBGE; Graphic by Ana Bodevan\"\n```\n:::\n\n\n### 3.2 Plot Map\n\n::: {.cell}\n\n```{.r .cell-code}\nmap <- ggplot() +\n  # South America context (light background)\n  geom_sf(data = shp_latam, fill = \"#F5f5f5\", color = \"gray80\", size = 0.15) +\n  \n  # Brazil states\n  geom_sf(data = shp_br, color = \"#BDBDBD\", fill = \"#dfe2e7ff\", size = 0.25) +\n\n  # Railways by status\n  geom_sf(data = shp_rail, aes(color = status, linetype = status), size = 0.5) +\n  \n  # Color scale for railways\n  scale_color_manual(\n    values = c(\n      \"Operating\" = \"#2C3E50\",           \n      \"Under Repair\" = \"#E67E22\",        \n      \"Under Study\" = \"#4987c2ff\",         \n      \"Deactivated\" = \"#C0392B\"          \n    ),\n    name = \"Railway Status\"\n  ) +\n  \n  # Line type according to status \n  scale_linetype_manual(\n    values = c(\n      \"Operating\" = \"solid\",             \n      \"Under Repair\" = \"dashed\",         \n      \"Under Study\" = \"dotted\",        \n      \"Deactivated\" = \"dotdash\"          \n    ),\n    name = \"Railway Status\"\n  ) +\n\n  # Set bounding box to focus on Brazil\n  coord_sf(xlim = c(bbox[\"xmin\"], bbox[\"xmax\"]),\n           ylim = c(bbox[\"ymin\"], bbox[\"ymax\"])) +\n\n  # Labs\n  labs(tag = \"\",\n      title = title,\n      subtitle = subtitle,\n      caption = caption) +\n\n  \n  # Theme \n  ggthemes::theme_map(base_family = \"inter\")  %+replace%\n  theme(\n    plot.background = element_rect(fill = \"white\", color = NA),\n    panel.background = element_rect(fill = \"white\", color = NA),\n\n    plot.title = element_text(family = \"inter\", face = \"bold\", size = 24, \n                              hjust = 0, margin = margin(b = 5)),\n    plot.subtitle = element_text(family = \"inter\", size = 12, \n                                 hjust = 0, margin = margin(b = 15)),\n    plot.caption = element_text(family = \"inter\", size = 8, hjust = 0, color = \"gray50\"),\n\n    legend.position = c(1.03, 0.35),   # (x, y): 1.0 = right edge, >1 = outside\n    legend.justification = c(\"left\", \"top\"),\n    legend.box.margin = margin(0, 0, 0, 0),\n    legend.background = element_rect(fill = \"white\", color = NA),\n    legend.title = element_text(face = \"bold\", size = 11),\n    legend.text = element_text(size = 10),\n\n    plot.margin = margin(10, 200, 5, 10)\n  )\n\nmap \n```\n\n::: {.cell-output-display}\n![](02_lines_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### 3.3 Plot Line Chart \n\n::: {.cell}\n\n```{.r .cell-code}\nline <- ggplot(km, aes(x = YEAR, y = KM)) +\n  geom_line(color = \"#2C3E50\", linewidth = 0.8) +\n\n  # Highlight the peak\n  geom_vline(xintercept = 1960, linetype = \"dashed\", color = \"#C0392B\", alpha = 0.5) +\n\n  scale_y_continuous(\n    labels = scales::label_number(scale = 1/1000, suffix = \"k\"),\n    breaks = seq(0, 35000, 5000)\n  ) +\n  scale_x_continuous(breaks = seq(1854, 2023, 30)) +\n  labs(\n    x = \"Year\",\n    y = \"Railway Extension (km)\",\n    title = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    plot.background = element_rect(fill = \"white\", color = NA),\n    panel.background = element_rect(fill = \"white\", color = NA),\n    panel.grid.minor = element_blank(),\n    panel.grid.major = element_line(color = \"gray90\", size = 0.3),\n    axis.title = element_text(family = \"inter\", size = 10, face = \"bold\"),\n    axis.text = element_text(family = \"inter\", size = 9, angle = 45),\n    axis.title.y = element_text(angle = 90, margin = margin(r = 10)),\n    axis.title.x = element_text(margin = margin(t = 10)),\n    plot.margin = margin(20, 20, 20, 20)\n  )\n\nline\n```\n\n::: {.cell-output-display}\n![](02_lines_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add a light border to your line chart for clarity\nline_box <- line +\n  theme(\n    plot.background = element_rect(fill = \"white\", color = \"gray85\", linewidth = 0.3),\n    panel.grid.major = element_line(color = \"gray90\", linewidth = 0.25),\n    axis.text = element_text(size = 8, family = \"inter\"),\n    axis.title = element_text(size = 9, family = \"inter\", face = \"bold\")\n  )\n\nfinal_plot <- ggdraw() +\n  draw_plot(map, x = 0, y = 0, width = 1, height = 1) +\n  draw_plot(\n    line_box,\n    x = 0.68,   \n    y = 0.35,   \n    width = 0.28, \n    height = 0.35,\n    hjust = 0,\n    vjust = 0\n  )\n\nfinal_plot\n```\n\n::: {.cell-output-display}\n![](02_lines_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "02_lines_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}